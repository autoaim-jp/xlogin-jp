<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: chatgptApi/src/core/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: chatgptApi/src/core/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import backendServerCore from './backendServerCore.js'

const mod = {}
const responseList = {}

const init = async ({
  setting, input, lib, amqpConnection,
}) => {
  const amqpChannel = await amqpConnection.createChannel()
  mod.amqpChannel = amqpChannel

  mod.setting = setting
  mod.lib = lib
  mod.input = input

  backendServerCore.init({ setting, input, lib })
}

/**
 * createPgPool.
 *
 * @param {} pg
 * @return {pg.Pool} DBの接続プール
 * @memberof core
 */
const createPgPool = ({ pg }) => {
  const dbCredential = {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    database: process.env.DB_NAME,
    user: process.env.DB_USER,
    password: process.env.DB_PASS,
    max: 5,
    idleTimeoutMillis: 5 * 1000,
    connectionTimeoutMillis: 5 * 1000,
  }

  return new pg.Pool(dbCredential)
}

const handleRegisterPrompt = async ({ clientId, accessToken, prompt }) => {
  const { execQuery, paramSnakeToCamel, checkPermission } = mod.lib.backendServerLib
  const operationKey = 'w'
  const range = mod.setting.getValue('server.AUTH_SERVER_CLIENT_ID')
  const dataType = 'chatgpt'
  const emailAddress = await mod.input.backendServerInput.checkPermissionAndGetEmailAddress({
    accessToken, clientId, operationKey, range, dataType, execQuery, paramSnakeToCamel, checkPermission,
  })

  if (!emailAddress) {
    const status = mod.setting.browserServerSetting.getValue('statusList.SERVER_ERROR')
    const error = 'handle_chatgpt_prompt_access_token'
    return backendServerCore.getErrorResponse({ status, error })
  }

  const queue = mod.setting.getValue('amqp.CHATGPT_PROMPT_QUEUE')
  await mod.amqpChannel.assertQueue(queue)

  const requestId = mod.lib.getUlid()
  const requestObj = {
    requestId,
    prompt,
  }
  const requestObjStr = JSON.stringify(requestObj)

  mod.amqpChannel.sendToQueue(queue, Buffer.from(requestObjStr))

  responseList[requestId] = { emailAddress }

  const handleResult = { isRegistered: true, requestId }
  return handleResult
}

const handleLookupChatgptResponse = async ({ clientId, accessToken, requestIdList }) => {
  const { execQuery, paramSnakeToCamel, checkPermission } = mod.lib.backendServerLib
  const operationKey = 'r'
  const range = mod.setting.getValue('server.AUTH_SERVER_CLIENT_ID')
  const dataType = 'chatgpt'
  const emailAddress = await mod.input.backendServerInput.checkPermissionAndGetEmailAddress({
    accessToken, clientId, operationKey, range, dataType, execQuery, paramSnakeToCamel, checkPermission,
  })

  if (!emailAddress) {
    const status = mod.setting.browserServerSetting.getValue('statusList.SERVER_ERROR')
    const error = 'handle_chatgpt_response_access_token'
    return backendServerCore.getErrorResponse({ status, error })
  }

  const handleResult = {}

  requestIdList.forEach((requestId) => {
    const responseObj = responseList[requestId]
    if (responseObj &amp;&amp; responseObj.response &amp;&amp; responseObj.response.response &amp;&amp; responseObj.emailAddress === emailAddress) {
      handleResult[requestId] = { waiting: false, result: responseObj.response.response }
    } else {
      handleResult[requestId] = { waiting: true }
    }
  })

  return handleResult
}

const startConsumer = async () => {
  const queue = mod.setting.getValue('amqp.CHATGPT_RESPONSE_QUEUE')
  await mod.amqpChannel.assertQueue(queue)

  mod.amqpChannel.consume(queue, (msg) => {
    if (msg !== null) {
      console.log('Recieved:', msg.content.toString())
      mod.amqpChannel.ack(msg)
      const responseJson = JSON.parse(msg.content.toString())
      if (!responseList[responseJson.requestId]) {
        return
      }
      responseList[responseJson.requestId].response = responseJson
    } else {
      console.log('Consumer cancelled by server')
      throw new Error()
    }
  })
}

export default {
  backendServerCore,
  init,
  createPgPool,
  handleRegisterPrompt,
  handleLookupChatgptResponse,
  startConsumer,
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Sun Dec 10 2023 15:33:19 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
